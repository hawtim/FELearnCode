# 有赞埋点实践

## 大数据应用

1. 采集
2. 加工
3. 存储
4. 计算
5. 可视化

埋点作为重要的采集手段

将用户信息转化为数据资产

1. 产品分析
2. 业务决策
3. 广告推荐

业务线、终端众多，数据需求多样？

保障埋点的质量

设计好埋点模型和采集规范、工具化、平台化、流程化

## 事件模型

who 访客标识、设备指纹、登录ID
when 事件发生时间、上报时间
where 设备环境、网络环境、业务环境等
what 事件标识、事件参数

客户小明——who
今天中午12点——when
在公司使用华为手机将周黑鸭商城——where
两盒特价鸭脖加入了购物车——what

设计承载以上信息的日志模型，并保持必要的可拓展性

## 采集方式

### 无痕埋点/全埋点

用浏览器或APP自带的监听方式，对用户的浏览页面、点击等行为进行收集

利用浏览器或APP自带的监听方式，对用户的浏览页面、点击等行为进行收集，可以收集到的信息主要有：

1. 页面的url、APP的包名等
2. 点击元素的xpath路径、title或约定的dom元素

无痕埋点的优势有：

1. 前端接入成本低，不需要额外开发
2. 用户动作收集完整，不会漏失

但同时也会存在以下问题：

1. 有用、没用的数据都会收集
2. 无法采集到特殊的行为动作、业务参数
3. 采集到的信息需要进行二次标注，才可以被用户识别
4. 当按钮的位置不固定、名称存在重复或页面重构时，无法做到准确的标识

无痕埋点在有赞一般用来做大颗粒度的**快速业务**探索。

### 代码埋点

代码埋点是指依赖前端同学，自定义监听和收集处理。代码埋点的优势有：

1. 事件标识明确
2. 业务参数丰富
3. 事件的触发方式可以灵活自定义
4. 分析更**方便**、**精确**

随之而来的是以下问题：

1. 前端代码的开发、管理成本
2. 只能收集到事件上线之后的数据
3. 在业务需求复杂，无痕埋点收集到的信息无法支持分析时，就需要进行代码埋点。

## 埋点 SDK

sdk默认支持以下功能：

- 访客标识管理
- 会话管理
- 环境参数默认收集
- 参数的生命周期管理
- 默认事件的收集
- 跨端的sdk通信（如app嵌套h5页面）
- 内部业务的特殊处理逻辑
- 日志的格式化、合并、生命周期管理
- 日志的上报机制

前端人员只需要关注：

- SDK的初始化配置
- 事件怎么标识
- 事件需要哪些参数
- 事件如何触发

## 日志中间层

数据收集上来后，原始日志需要进一步加工成日志中间层

1. **批量上报的日志拆分**
2. 日志模型的格式化处理
3. 信息的二次加工和维度拓展
4. **异常流量的清洗**
5. 会话信息的补充，如落地页，二跳页，停留时长的计算
6. 按业务拆分日志流和日志表

实时流中间层是以`JSON`格式存储在`kafka`中，并且提供对应的`JavaBean`类，方便实时任务开发解析处理，并且也可以与`streamSql`相结合使用。
离线中间层是存储在**同一个表**中，字段与实时流格式保持一致，*以日期和业务作为分区条件*，并会自动创建所有业务的**视图表**，方便中间层的统一调整以及数仓的权限管理。

## 位置追踪规范

我们将位置分成了四个粒度：

- 业务
- 页面域（包括页面类型和页面id）
- 组件域（如图中红色部分，包括组件类型和组件序号）
- 展位域（如图中绿色部分，包括展位标识和展位序号）

业务 + 页面域 + 组件域 + 展位域 + 页面随机码，可以唯一确定一个访问的位置。基于位置分解出来的维度组合，可以很方便的分析出各个粒度的访问、曝光、点击数据。

## 埋点管理平台

平台建设的必要性，主要涉及以下几点能力：

1. 埋点元数据的管理及开放能力
2. 埋点流程的管理能力

有了以上两点能力后，延伸出来的操作空间

- 埋点的自动测试
- 埋点的自助分析
- 埋点的开发提示
- 埋点的质量监控

### 埋点元数据管理

元数据的组成分为 `业务`、 `页面`、 `组件`、 `展位`、 `事件`

- 业务：由业务类型（微商城、零售等）和SDK类型（js/小程序/android/ios/java）唯一确定。页面、组件、展位、事件等属于且仅属于一个业务。
- 页面：具有相同页面结构的一类网页或者移动端页面。
- 组件：页面内的区块，也包括跨页面的可复用区块。
- 展位：组件内最细粒度的坑位，有三种位置标识，即递增（顺序排列）、固定（特定的位置）和正则标识（复杂布局）。
- 事件：埋点基本单元，对应用户的一个动作，比如**进入页面**、**点击按钮**、**商品曝光**等，每个事件还可以定义独有的参数。按其归属，可以分为全局事件、页面事件和组件事件。


